version: '3'

vars:
  CONFIG_DIR: './config'
  SCRIPTS_DIR: './scripts'

  _:
    sh: |
      _=$(git config --global --unset-all safe.directory || true)
      _=$(git config --global --add safe.directory "*")
  GIT_BRANCH:
    sh: git rev-parse --abbrev-ref HEAD
  GIT_AUTHOR:
    sh: git config user.name || whoami
  GIT_CHANGES:
    sh: |
      for file in $(git diff HEAD HEAD~ --name-only)
      do
          echo "  - ${file}"
      done
  GIT_COMMIT:
    sh: git log -n 1 --format=%h

tasks:
  push:
    cmds:
      - git add .
      - cmd: git commit -am "{{.MESSAGE}}"
        ignore_error: true
      - cmd: git push
        ignore_error: true
    vars:
      MESSAGE: '[skip ci] Development commit'

  default:
    - 'echo Running in: $(pwd) as $(whoami)'
    - 'echo OS: {{OS}}:{{ARCH}}'
    - 'echo Time: {{now | date "2006-01-02 15:04:05"}}'
    - 'echo Build directory: {{.BUILD_DIR}}'
    - echo "{{.GIT_BRANCH}} - unofficial & generated by {{.GIT_AUTHOR}}"
    - echo "Changes are:"
    - echo "{{.GIT_CHANGES}}"
